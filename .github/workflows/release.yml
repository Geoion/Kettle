name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
      
      - name: Setup variables
        id: setup
        run: |
          # è·å–ç‰ˆæœ¬å·ï¼ˆç§»é™¤ 'v' å‰ç¼€ï¼‰
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # è·å–ä¸Šä¸€ä¸ªæ„å»ºå·å¹¶å¢åŠ 
          LAST_BUILD_NUMBER=$(defaults read $(pwd)/Kettle/Info.plist CFBundleVersion 2>/dev/null || echo "0")
          BUILD_NUMBER=$((LAST_BUILD_NUMBER + 1))
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          
          # è®¾ç½® DMG æ–‡ä»¶å
          DMG_NAME="Kettle-$VERSION.dmg"
          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV
          echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT
      
      - name: Update version and build number
        run: |
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p Kettle
          
          # æ£€æŸ¥ Info.plist æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          if [ ! -f Kettle/Info.plist ]; then
            echo '<?xml version="1.0" encoding="UTF-8"?>' > Kettle/Info.plist
            echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> Kettle/Info.plist
            echo '<plist version="1.0">' >> Kettle/Info.plist
            echo '<dict>' >> Kettle/Info.plist
            echo '    <key>CFBundleIconFile</key>' >> Kettle/Info.plist
            echo '    <string>AppIcon</string>' >> Kettle/Info.plist
            echo '    <key>CFBundleIconName</key>' >> Kettle/Info.plist
            echo '    <string>AppIcon</string>' >> Kettle/Info.plist
            echo '    <key>CFBundleShortVersionString</key>' >> Kettle/Info.plist
            echo '    <string>1.0.0</string>' >> Kettle/Info.plist
            echo '    <key>CFBundleVersion</key>' >> Kettle/Info.plist
            echo '    <string>1</string>' >> Kettle/Info.plist
            echo '</dict>' >> Kettle/Info.plist
            echo '</plist>' >> Kettle/Info.plist
          fi
          
          # æ›´æ–°ç‰ˆæœ¬å·å’Œæ„å»ºå·
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" Kettle/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" Kettle/Info.plist
          
          echo "ğŸ“± App version updated to $VERSION (Build: $BUILD_NUMBER)"
      
      - name: Build app
        run: |
          # è®¾ç½® Xcode é¡¹ç›®è·¯å¾„
          XCODEPROJ_PATH="Kettle.xcodeproj"
          
          # æ„å»ºåº”ç”¨
          xcodebuild clean archive -project "$XCODEPROJ_PATH" -scheme "Kettle" -archivePath "build/Kettle.xcarchive" CODE_SIGN_IDENTITY="-"
          
          # å¯¼å‡ºä¸º DMG
          # æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–äº†ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ­¥éª¤åˆ›å»º DMG
          # å¦‚æœæ‚¨æœ‰ç°æˆçš„è„šæœ¬åˆ›å»º DMGï¼Œå¯ä»¥è°ƒç”¨å®ƒ
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p build/dmg
          cp -R build/Kettle.xcarchive/Products/Applications/Kettle.app build/dmg/
          
          # åˆ›å»º DMG
          hdiutil create -volname "Kettle" -srcfolder build/dmg -ov -format UDZO "build/$DMG_NAME"
          
          echo "ğŸ“¦ App built and DMG created at build/$DMG_NAME"
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Kettle ${{ env.VERSION }}
          draft: false
          prerelease: false
          files: build/${{ env.DMG_NAME }}
          body: |
            # Kettle v${{ env.VERSION }} (Build ${{ env.BUILD_NUMBER }})
            
            ## æ›´æ–°å†…å®¹
            - è‡ªåŠ¨ä» Git tag æ„å»ºçš„ç‰ˆæœ¬
            
            ## ä¸‹è½½
            - macOS: [Kettle-${{ env.VERSION }}.dmg](https://github.com/Geoion/kettle/releases/download/v${{ env.VERSION }}/Kettle-${{ env.VERSION }}.dmg)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
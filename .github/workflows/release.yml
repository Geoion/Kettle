name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
      
      - name: Setup variables
        run: |
          # è·å–ç‰ˆæœ¬å·ï¼ˆç§»é™¤ 'v' å‰ç¼€ï¼‰
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # è®¾ç½®æ„å»ºå·ï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          
          # è®¾ç½® DMG æ–‡ä»¶å
          DMG_NAME="Kettle-$VERSION.dmg"
          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV
      
      - name: Find Info.plist
        run: |
          # æŸ¥æ‰¾é¡¹ç›®ä¸­çš„æ‰€æœ‰ Info.plist æ–‡ä»¶
          PLIST_FILES=$(find . -name "Info.plist" | grep -v "build" || echo "")
          echo "Found Info.plist files: $PLIST_FILES"
          
          # å¦‚æœæ‰¾åˆ°å¤šä¸ªæ–‡ä»¶ï¼Œé€‰æ‹© Kettle/Info.plist
          if [[ -f "./Kettle/Info.plist" ]]; then
            echo "PLIST_PATH=./Kettle/Info.plist" >> $GITHUB_ENV
            echo "Found main Info.plist at ./Kettle/Info.plist"
          elif [[ -n "$PLIST_FILES" ]]; then
            # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª Info.plist
            FIRST_PLIST=$(echo "$PLIST_FILES" | head -n 1)
            echo "PLIST_PATH=$FIRST_PLIST" >> $GITHUB_ENV
            echo "Using Info.plist at $FIRST_PLIST"
          else
            echo "No Info.plist found. Will create one."
            mkdir -p Kettle
            echo "PLIST_PATH=./Kettle/Info.plist" >> $GITHUB_ENV
          fi
      
      - name: Create Info.plist if needed
        run: |
          PLIST_PATH="${PLIST_PATH:-./Kettle/Info.plist}"
          if [ ! -f "$PLIST_PATH" ]; then
            echo "Creating new Info.plist at $PLIST_PATH"
            mkdir -p $(dirname "$PLIST_PATH")
            echo '<?xml version="1.0" encoding="UTF-8"?>' > "$PLIST_PATH"
            echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$PLIST_PATH"
            echo '<plist version="1.0">' >> "$PLIST_PATH"
            echo '<dict>' >> "$PLIST_PATH"
            echo '    <key>CFBundleIconFile</key>' >> "$PLIST_PATH"
            echo '    <string>AppIcon</string>' >> "$PLIST_PATH"
            echo '    <key>CFBundleIconName</key>' >> "$PLIST_PATH"
            echo '    <string>AppIcon</string>' >> "$PLIST_PATH"
            echo '    <key>CFBundleShortVersionString</key>' >> "$PLIST_PATH"
            echo '    <string>1.0.0</string>' >> "$PLIST_PATH"
            echo '    <key>CFBundleVersion</key>' >> "$PLIST_PATH"
            echo '    <string>1</string>' >> "$PLIST_PATH"
            echo '</dict>' >> "$PLIST_PATH"
            echo '</plist>' >> "$PLIST_PATH"
          fi
      
      - name: Check and add required keys
        run: |
          PLIST_PATH="${PLIST_PATH:-./Kettle/Info.plist}"
          if ! /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$PLIST_PATH" &>/dev/null; then
            echo "Adding CFBundleShortVersionString to Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string 1.0.0" "$PLIST_PATH"
          fi
          
          if ! /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST_PATH" &>/dev/null; then
            echo "Adding CFBundleVersion to Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string 1" "$PLIST_PATH"
          fi
      
      - name: Update version and build number
        run: |
          PLIST_PATH="${PLIST_PATH:-./Kettle/Info.plist}"

          # ç¡®ä¿ä½¿ç”¨æ ‡å‡†æ ¼å¼çš„ç‰ˆæœ¬å·å’Œæ„å»ºå·
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$PLIST_PATH"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$PLIST_PATH"
          
          echo "ğŸ“± App version updated to $VERSION (Build: $BUILD_NUMBER)"
          echo "Info.plist content:"
          cat "$PLIST_PATH"
          
          # ç¡®ä¿æ„å»ºå‰èƒ½çœ‹åˆ°æ›´æ–°åçš„ Info.plist
          cp -f "$PLIST_PATH" "./Kettle/Info.plist" || echo "Already in the right place"
          
          # ç¡®è®¤æœ€ç»ˆçš„ Info.plist å†…å®¹
          echo "Final Info.plist content for build:"
          cat "./Kettle/Info.plist"
      
      - name: List available schemes
        run: |
          echo "Available schemes:"
          xcodebuild -list -project "Kettle.xcodeproj" || echo "Failed to list schemes"
      
      - name: Build app
        run: |
          # å°è¯•æ„å»ºåº”ç”¨
          xcodebuild clean archive \
            -project "Kettle.xcodeproj" \
            -scheme "Kettle" \
            -archivePath "build/Kettle.xcarchive" \
            CODE_SIGN_IDENTITY="-" \
            CURRENT_PROJECT_VERSION=$BUILD_NUMBER \
            MARKETING_VERSION=$VERSION || {
            
            echo "Build failed. Trying alternate scheme..."
            # å°è¯•æ„å»ºç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ scheme
            FIRST_SCHEME=$(xcodebuild -list -project "Kettle.xcodeproj" -json 2>/dev/null | grep -o '"name" : "[^"]*"' | head -1 | cut -d'"' -f4)
            if [ -n "$FIRST_SCHEME" ]; then
              echo "Trying to build with scheme: $FIRST_SCHEME"
              xcodebuild clean archive \
                -project "Kettle.xcodeproj" \
                -scheme "$FIRST_SCHEME" \
                -archivePath "build/Kettle.xcarchive" \
                CODE_SIGN_IDENTITY="-" \
                CURRENT_PROJECT_VERSION=$BUILD_NUMBER \
                MARKETING_VERSION=$VERSION
            else
              echo "No schemes found. Build failed."
              exit 1
            fi
          }
      
      - name: Install create-dmg
        run: |
          brew install create-dmg
          
      - name: Create DMG
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p build/dmg
          cp -R build/Kettle.xcarchive/Products/Applications/Kettle.app build/dmg/ || {
            echo "Failed to copy app. Checking actual path..."
            find build -name "*.app"
            APP_PATH=$(find build -name "*.app" | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "Found app at: $APP_PATH"
              cp -R "$APP_PATH" build/dmg/
            else
              echo "No app found. Build failed."
              exit 1
            fi
          }
          
          # åˆ›å»ºå¸¦æœ‰ Applications é“¾æ¥çš„ DMG
          APP_NAME="Kettle"
          DMG_DIR="build/dmg_final"
          mkdir -p "$DMG_DIR"
          cp -R "build/dmg/Kettle.app" "$DMG_DIR"
          
          # åˆ›å»ºæŒ‡å‘ Applications çš„ç¬¦å·é“¾æ¥
          ln -s /Applications "$DMG_DIR/Applications"
          
          # ä½¿ç”¨ create-dmg åˆ›å»ºç¾è§‚çš„ DMG
          DMG_PATH="build/$DMG_NAME"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å›¾æ ‡æ–‡ä»¶
          ICON_OPTION=""
          if [ -f "Kettle/Resources/AppIcon.icns" ]; then
            ICON_OPTION="--volicon Kettle/Resources/AppIcon.icns"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰èƒŒæ™¯å›¾åƒ
          BG_OPTION=""
          if [ -f "Kettle/Resources/dmg-background.png" ]; then
            BG_OPTION="--background Kettle/Resources/dmg-background.png"
          fi
          
          create-dmg \
            --volname "$APP_NAME" \
            $ICON_OPTION \
            $BG_OPTION \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME.app" 150 190 \
            --hide-extension "$APP_NAME.app" \
            --app-drop-link 450 190 \
            --no-internet-enable \
            "$DMG_PATH" \
            "$DMG_DIR" \
          || {
            echo "Failed to create fancy DMG. Falling back to simple DMG with Applications link."
            # åˆ›å»ºç®€å•çš„ DMG ä½œä¸ºå¤‡é€‰ï¼Œä½†ä¿ç•™ Applications é“¾æ¥
            hdiutil create -volname "Kettle" -srcfolder "$DMG_DIR" -ov -format UDZO "$DMG_PATH"
          }
          
          echo "ğŸ“¦ App built and DMG created at build/$DMG_NAME"
      
      - name: Upload DMG as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kettle-${{ env.VERSION }}-${{ env.BUILD_NUMBER }}
          path: build/${{ env.DMG_NAME }}
          
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/${{ env.DMG_NAME }}"
          name: "Kettle ${{ env.VERSION }}"
          body: |
            # Kettle v${{ env.VERSION }} (Build ${{ env.BUILD_NUMBER }})
            
            ## æ›´æ–°å†…å®¹
            - è‡ªåŠ¨ä» Git tag æ„å»ºçš„ç‰ˆæœ¬
            - æ„å»ºæ—¶é—´: ${{ env.BUILD_NUMBER }}
            
            ## ä¸‹è½½
            - macOS: Kettle-${{ env.VERSION }}.dmg
          allowUpdates: true
          makeLatest: true 